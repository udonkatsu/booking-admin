<!DOCTYPE html>
<html lang="id">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Halaman Admin Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    let bookingsCache = [];

    async function loadBookings() {
        const response = await fetch('https://skripsi-kang-n8n.hgsuzl.easypanel.host/webhook/get-booking');
        const data = await response.json();
        bookingsCache = data;
        const tbody = document.getElementById('booking-body');
        tbody.innerHTML = '';

        data.forEach(booking => {
            const row = document.createElement('tr');
            row.classList.add('border-b');

            let actionsHTML = '';

            if (booking["Status Booking"] === 'pending') {
                actionsHTML = `
            <button onclick="konfirmasiBooking('${booking["Booking ID"]}', 'approved')" class="bg-green-600 text-white px-3 py-1 rounded hover:bg-green-700">Terima</button>
            <button onclick="konfirmasiBooking('${booking["Booking ID"]}', 'rejected')" class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700">Tolak</button>
            <button onclick="editBooking('${booking["Booking ID"]}')" class="bg-yellow-500 text-white px-3 py-1 rounded hover:bg-yellow-600">Edit</button>
          `;
            } else {
                actionsHTML = `
            <span class="text-gray-400 italic">Sudah dikonfirmasi (${booking["Status Booking"]})</span>
            <button onclick="editBooking('${booking["Booking ID"]}')" class="ml-2 bg-blue-500 text-white px-3 py-1 rounded hover:bg-blue-600">Edit</button>
            <button onclick="konfirmasiBooking('${booking["Booking ID"]}', 'cancelled')" class="ml-2 bg-gray-600 text-white px-3 py-1 rounded hover:bg-gray-700">Batalkan</button>
          `;
            }

            row.innerHTML = `
          <td class="px-6 py-4">${booking["Booking ID"]}</td>
          <td class="px-6 py-4">${booking["Nama Customer"]}</td>
          <td class="px-6 py-4">${booking.Email}</td>
          <td class="px-6 py-4">${booking["Nomor Telepon"]}</td>
          <td class="px-6 py-4">${booking["Tanggal Booking"]}</td>
          <td class="px-6 py-4">${booking["Waktu Booking"]}</td>
          <td class="px-6 py-4">${booking["Jumlah Orang"]}</td>
          <td class="px-6 py-4">${booking["Tujuan Wisata"]}</td>
          <td class="px-6 py-4">${booking["Catatan Tambahan"]}</td>
          <td class="px-6 py-4">${booking["Tanggal Permintaan"]}</td>
          <td class="px-6 py-4">${booking["Tanggal Konfirmasi"]}</td>
          <td class="px-6 py-4">${booking["Petugas Konfirmasi"]}</td>
          <td class="px-6 py-4">${booking["Metode Konfirmasi"]}</td>
          <td class="px-6 py-4 font-semibold ${booking["Status Booking"] === 'approved' ? 'text-green-600' : booking["Status Booking"] === 'rejected' ? 'text-red-600' : 'text-yellow-500'}">${booking["Status Booking"]}</td>
          <td class="px-6 py-4">
            <div class="flex flex-wrap gap-2">
              ${actionsHTML}
            </div>
          </td>
        `;
            tbody.appendChild(row);
        });
    }

    async function konfirmasiBooking(bookingId, status) {
        const confirmed = confirm(
            `Apakah Anda yakin ingin mengubah status booking ID ${bookingId} menjadi ${status}?`
        );
        if (!confirmed) return;

        try {
            const response = await fetch(
                'https://skripsi-kang-n8n.hgsuzl.easypanel.host/webhook/konfirmasi-booking', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        booking_id: bookingId,
                        status
                    })
                });

            if (response.ok) {
                alert(`Booking ${bookingId} berhasil dikonfirmasi sebagai ${status}.`);
                loadBookings();
            } else {
                alert('Gagal mengirim konfirmasi. Coba lagi nanti.');
            }
        } catch (error) {
            console.error(error);
            alert('Terjadi kesalahan saat mengirim data ke server.');
        }
    }

    function editBooking(bookingId) {
        const booking = bookingsCache.find(b => b["Booking ID"] === bookingId);
        if (!booking) return alert("Data tidak ditemukan.");

        const form = document.getElementById("edit-form");
        document.getElementById("popup").classList.remove("hidden");

        form.booking_id.value = booking["Booking ID"];
        form.nama.value = booking["Nama Customer"];
        form.email.value = booking.Email;
        form.telepon.value = booking["Nomor Telepon"];
        form.tanggal.value = booking["Tanggal Booking"];
        form.waktu.value = booking["Waktu Booking"];
        form.jumlah.value = booking["Jumlah Orang"];
        form.tujuan.value = booking["Tujuan Wisata"];
        form.catatan.value = booking["Catatan Tambahan"];
    }

    function closePopup() {
        document.getElementById("popup").classList.add("hidden");
    }

    document.addEventListener('DOMContentLoaded', function() {
        loadBookings();

        const form = document.getElementById('edit-form');
        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = {
                booking_id: form.booking_id.value,
                nama: form.nama.value,
                email: form.email.value,
                telepon: form.telepon.value,
                tanggal: form.tanggal.value,
                waktu: form.waktu.value,
                jumlah: form.jumlah.value,
                tujuan: form.tujuan.value,
                catatan: form.catatan.value,
            };

            try {
                const response = await fetch(
                    'https://skripsi-kang-n8n.hgsuzl.easypanel.host/webhook/edit-booking', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(formData)
                    });

                if (response.ok) {
                    alert('Booking berhasil diperbarui.');
                    closePopup();
                    loadBookings();
                } else {
                    alert('Gagal memperbarui booking.');
                }
            } catch (error) {
                console.error(error);
                alert('Terjadi kesalahan saat mengirim data ke server.');
            }
        });
    });
    </script>
</head>

<div class="w-full text-gray-700 bg-white dark-mode:text-gray-200 dark-mode:bg-gray-800">
    <div x-data="{ open: false }"
        class="flex flex-col max-w-screen-xl px-4 mx-auto md:items-center md:justify-between md:flex-row md:px-6 lg:px-8">
        <div class="p-4 flex flex-row items-center justify-between">
            <a href="/" class="flex items-center">
                <img src="/images/logo.png" alt="Bali TourGuide Logo" class="h-10 w-auto">
                <span
                    class="ml-2 text-lg font-semibold tracking-widest text-gray-900 uppercase rounded-lg dark-mode:text-white focus:outline-none focus:shadow-outline">Bali
                    Wishful <span class="text-yellow-500">Trips</span>
                </span>
            </a>
            <button class="md:hidden rounded-lg focus:outline-none focus:shadow-outline" @click="open = !open">
                <svg fill="currentColor" viewBox="0 0 20 20" class="w-6 h-6">
                    <path x-show="!open" fill-rule="evenodd"
                        d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM9 15a1 1 0 011-1h6a1 1 0 110 2h-6a1 1 0 01-1-1z"
                        clip-rule="evenodd"></path>
                    <path x-show="open" fill-rule="evenodd"
                        d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                        clip-rule="evenodd"></path>
                </svg>
            </button>
        </div>
        <nav :class="{'flex': open, 'hidden': !open}"
            class="flex-col flex-grow pb-4 md:pb-0 hidden md:flex md:justify-end md:flex-row md:pt-5">
            <div class="relative">
                <button onclick="window.location.href='/logout'"
                    class="flex flex-row items-center w-full px-4 py-2 mt-2 text-sm font-semibold text-left text-white bg-red-500 rounded-lg dark-mode:bg-red-700 dark-mode:focus:text-white dark-mode:hover:text-white dark-mode:focus:bg-red-600 dark-mode:hover:bg-red-600 md:w-auto md:inline md:mt-0 md:ml-4 hover:bg-red-600 focus:bg-red-600 focus:outline-none focus:shadow-outline">
                    <span>Logout</span>
                </button>
            </div>
        </nav>
    </div>
</div>

<body class="bg-gray-50 flex flex-col min-h-screen">
    <main class="flex-1 p-8 container mx-auto">
        <h1 class="text-3xl font-bold mb-6">Halaman Admin - Konfirmasi Booking</h1>

        <div class="bg-white shadow rounded-lg overflow-y-auto" style="height: calc(100vh - 12rem);">
            <table class="w-full text-sm text-left text-gray-700">
                <thead class="bg-gray-200 text-xs uppercase sticky top-0">
                    <tr>
                        <th class="px-6 py-3">ID</th>
                        <th class="px-6 py-3">Nama</th>
                        <th class="px-6 py-3">Email</th>
                        <th class="px-6 py-3">Telepon</th>
                        <th class="px-6 py-3">Tanggal</th>
                        <th class="px-6 py-3">Waktu</th>
                        <th class="px-6 py-3">Orang</th>
                        <th class="px-6 py-3">Tujuan</th>
                        <th class="px-6 py-3">Catatan</th>
                        <th class="px-6 py-3">Permintaan</th>
                        <th class="px-6 py-3">Konfirmasi</th>
                        <th class="px-6 py-3">Petugas</th>
                        <th class="px-6 py-3">Metode</th>
                        <th class="px-6 py-3">Status</th>
                        <th class="px-6 py-3">Aksi</th>
                    </tr>
                </thead>
                <tbody id="booking-body"></tbody>
            </table>
        </div>
    </main>

    <div id="popup" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden z-50">
        <div class="bg-white w-full max-w-2xl p-6 rounded-lg shadow-lg">
            <h2 class="text-xl font-bold mb-4">Edit Booking</h2>
            <form id="edit-form" class="grid grid-cols-1 gap-4">
                <input type="hidden" name="booking_id">
                <div>
                    <label class="block text-sm font-medium">Nama:</label>
                    <input type="text" name="nama" class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Email:</label>
                    <input type="email" name="email" class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Telepon:</label>
                    <input type="text" name="telepon" class="w-full border rounded p-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium">Tanggal:</label>
                        <input type="date" name="tanggal" class="w-full border rounded p-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Waktu:</label>
                        <input type="time" name="waktu" class="w-full border rounded p-2">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium">Jumlah Orang:</label>
                    <input type="number" name="jumlah" class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Tujuan Wisata:</label>
                    <input type="text" name="tujuan" class="w-full border rounded p-2">
                </div>
                <div>
                    <label class="block text-sm font-medium">Catatan Tambahan:</label>
                    <textarea name="catatan" class="w-full border rounded p-2"></textarea>
                </div>
                <div class="flex justify-end gap-4 mt-4">
                    <button type="button" onclick="closePopup()"
                        class="bg-gray-400 text-white px-4 py-2 rounded hover:bg-gray-500">Batal</button>
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</body>

</html>
